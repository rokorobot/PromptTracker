// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique
  email         String   @unique
  name          String?
  imageUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ownedWorkspaces    Workspace[]       @relation("WorkspaceOwner")
  workspaceMembers   WorkspaceMember[]
  createdPrompts     Prompt[]          @relation("PromptCreator")
  createdVersions    PromptVersion[]   @relation("VersionCreator")
  promptRuns         PromptRun[]       @relation("RunCreator")

  @@map("users")
}

model Workspace {
  id        String        @id @default(uuid())
  name      String
  type      WorkspaceType @default(PERSONAL)
  ownerId   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  owner       User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     WorkspaceMember[]
  prompts     Prompt[]
  collections Collection[]

  @@map("workspaces")
}

enum WorkspaceType {
  PERSONAL
  TEAM
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  role        MemberRole
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

enum MemberRole {
  OWNER
  EDITOR
  VIEWER
}

model Collection {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  prompts   Prompt[]

  @@map("collections")
}

model Prompt {
  id           String   @id @default(uuid())
  workspaceId  String
  collectionId String?
  title        String
  description  String?
  isPublic     Boolean  @default(false)
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace  Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  collection Collection?     @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  createdBy  User            @relation("PromptCreator", fields: [createdById], references: [id], onDelete: Cascade)
  versions   PromptVersion[]
  tags       PromptTag[]

  @@index([workspaceId])
  @@index([createdById])
  @@index([collectionId])
  @@map("prompts")
}

model PromptVersion {
  id            String   @id @default(uuid())
  promptId      String
  versionNumber Int
  content       String
  model         String?
  isDefault     Boolean  @default(false)
  createdById   String
  createdAt     DateTime @default(now())

  prompt    Prompt      @relation(fields: [promptId], references: [id], onDelete: Cascade)
  createdBy User        @relation("VersionCreator", fields: [createdById], references: [id], onDelete: Cascade)
  runs      PromptRun[]

  @@unique([promptId, versionNumber])
  @@index([promptId])
  @@index([isDefault])
  @@map("prompt_versions")
}

model PromptRun {
  id               String   @id @default(uuid())
  promptVersionId  String
  usedModel        String?
  rating           Int?
  notes            String?
  responseLength   Int?
  createdById      String
  createdAt        DateTime @default(now())

  promptVersion PromptVersion @relation(fields: [promptVersionId], references: [id], onDelete: Cascade)
  createdBy     User          @relation("RunCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([promptVersionId])
  @@index([createdById])
  @@map("prompt_runs")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  prompts PromptTag[]

  @@map("tags")
}

model PromptTag {
  promptId String
  tagId    String

  prompt Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([promptId, tagId])
  @@map("prompt_tags")
}
